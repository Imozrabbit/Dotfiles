#!/usr/bin/env bash
set -euo pipefail

# Menu 
printf "\033[1;36m Compile & Upload options:\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎦  Compile & upload an attached sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎩  Compile only an attach sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎬  Compile & upload an unattached sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎮  Compile only an unattached sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎰  Back to the main menu\033[0m\n"
printf "\033[1;36mYour choice ›\033[0m "
read -r choice

case "${choice:-}" in
    1)
        # Prompt for sketch name
        printf "\033[1;36mAttached sketch name ›\033[0m "
        read -r name
        [ -n "${name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No name given. Exiting."; exit 1; }
        SKETCH_DIR="$HOME/Documents/Arduino/Sketchbook/$name"

        # check if sketch folder contains the yaml file
        if ! ls "$SKETCH_DIR"/sketch.yaml >/dev/null 2>&1; then
        printf "\033[1;31m%s\033[0m\n" "No yaml file found in: $SKETCH_DIR (Go to sketch option to attach the sketch)"
        exit 1
        fi

        # Compile and upload
        arduino-cli compile -u \
            --build-path "$SKETCH_DIR/.intermediate_build" \
            --warnings all \
            "$SKETCH_DIR"
    ;;
    2)
        # Prompt for sketch name
        printf "\033[1;36mAttached sketch name ›\033[0m "
        read -r name
        [ -n "${name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No name given. Exiting."; exit 1; }
        SKETCH_DIR="$HOME/Documents/Arduino/Sketchbook/$name"

        # check if sketch folder contains the yaml file
        if [ ! -f "$SKETCH_DIR/sketch.yaml" ]; then
        printf "\033[1;31m%s\033[0m\n" "No yaml file found in: $SKETCH_DIR (Go to sketch option to attach the sketch)"
        exit 1
        fi

        # Compile only
        arduino-cli compile \
            --build-path "$SKETCH_DIR/.intermediate_build" \
            --warnings all \
            "$SKETCH_DIR"
    ;;
    3)
        # Prompt for entering fqbn
        printf "\033[1;36mFQBN ›\033[0m "
        read -r fqbn
        [ -n "${fqbn:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No fqbn given. Exiting."; exit 1; }

        # Prompt for entering the sketch to compile
        printf "\033[1;36mSketch to compile ›\033[0m "
        read -r sketch_name
        [ -n "${sketch_name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No sketch name given. Exiting."; exit 1; }

        # Check if the sketch exists
        SKETCH_DIR="$HOME/Documents/Arduino/Sketchbook/$sketch_name"
        [ -d "$SKETCH_DIR" ] || { printf "\033[1;31m%s\033[0m\n" "$sketch_name not found in sketchbook"; exit 1; }

        # Compile
        arduino-cli compile \
            --fqbn "$fqbn" \
            --build-path "$SKETCH_DIR/.intermediate_build" \
            --warnings all \
            "$SKETCH_DIR" 

        # Prompt to capture the serial port device name
        printf "\033[1;36mSerial port device name ›\033[0m "
        read -r device
        [ -n "${device:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No device name given. Exiting."; exit 1; }

        # Register serial port's path
        PORT="/dev/$device"

        # Check if the device can be found and can be accessed
        [ -c "$PORT" ] || { printf "\033[1;31m%s\033[0m\n" "Device not found: $PORT, make sure that it is plugged in"; exit 1; }
        [ -r "$PORT" ] && [ -w "$PORT" ] || printf "\033[1;33m%s\033[0m\n" "Warning: may lack permission for $PORT (dialout/uucp group?)"

        # Upload
        arduino-cli upload -p "$PORT" --fqbn "$fqbn" "$SKETCH_DIR"
    ;;
    4)
        # Prompt for entering fqbn
        printf "\033[1;36mFQBN ›\033[0m "
        read -r fqbn
        [ -n "${fqbn:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No fqbn given. Exiting."; exit 1; }

        # Prompt for entering the sketch to compile
        printf "\033[1;36mSketch to compile ›\033[0m "
        read -r sketch_name
        [ -n "${sketch_name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No sketch name given. Exiting."; exit 1; }

        # Check if the sketch exists
        SKETCH_DIR="$HOME/Documents/Arduino/Sketchbook/$sketch_name"
        [ -d "$SKETCH_DIR" ] || { printf "\033[1;31m%s\033[0m\n" "$sketch_name not found in sketchbook"; exit 1; }

        # Compile
        arduino-cli compile \
            --fqbn "$fqbn" \
            --build-path "$SKETCH_DIR/.intermediate_build" \
            --warnings all \
            "$SKETCH_DIR" 
    ;;
    5|b|B|back|BACK)
        clear
        arduino
    ;;
    *)
        printf "\033[1;31m%s\033[0m\n" "Not a valid option"
        exit 1
    ;;
esac
