#!/usr/bin/env bash
set -euo pipefail

printf "\033[1;36m󰍹 Monitor Options:\033[0m\n"

# Prompt to capture the serial port device name
printf "\033[1;36mDevice Name › \033[0m "
read -r device
[ -n "${device:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No device name given. Exiting."; exit 1; }

# Allow only safe basenames
if [[ ! "$device" =~ ^tty(ACM|USB|S)[0-9]+$ ]]; then
  printf "\033[1;31m%s\033[0m\n" "Invalid device name: $device"
  printf "\033[1;33m%s\033[0m\n" "Expected something like ttyACM0, ttyUSB0, ttyS0"
  exit 1
fi

# Register serial port's path
PORT="/dev/$device"

# Check device exists
[ -c "$PORT" ] || { printf "\033[1;31m%s\033[0m\n" "Device not found: $PORT, is it plugged in ?"; exit 1; }

# Permission hint
if [[ ! -r "$PORT" || ! -w "$PORT" ]]; then
  printf "\033[1;31m%s\033[0m\n" "Permission denied for $PORT"
  printf "\033[1;33m%s\033[0m\n" "Fix: add your user to the right group (often dialout/uucp) then re-login."
  exit 1
fi

# Prompt to capture the baud rate
printf "\033[1;36mBaud Rate › \033[0m "
read -r rate
[ -n "${rate:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No baud rate given. Exiting."; exit 1; }

# Verify if the baud rate is an interger
if [[ ! "$rate" =~ ^[0-9]+$ ]]; then
  printf "\033[1;31m%s\033[0m\n" "Invalid baud rate: $rate, numbers only)"
  exit 1
fi

# Open the monitor
exec screen -t "$PORT" "$PORT" "$rate"
