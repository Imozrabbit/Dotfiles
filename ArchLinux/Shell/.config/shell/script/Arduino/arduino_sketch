#!/usr/bin/env bash
set -euo pipefail

# Simple terminal menu
printf "\033[1;36m Sketch Options:\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎦  Create a new sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎩  Attach a sketch to a board\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎬  Archive a sketch\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎮  List all the available sketches\033[0m\n"
printf "\033[38;5;208m  ⤷ 󰎰  Back to the main menu\033[0m\n"
printf "\033[1;36mYour choice ›\033[0m "
read -r choice

case "${choice:-}" in
  1|new|New|n|N)
    # Prompt for sketch name
    printf "\033[1;36mSketch name ›\033[0m "
    read -r name
    [ -n "${name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No name given. Exiting."; exit 1; }

    # Go to the sketchbook directory
    cd "$HOME/Documents/Arduino/Sketchbook/" || { printf "\033[1;31m%s\033[0m\n" "Sketchbook folder not found: $HOME/Documents/Arduino/Sketchbook/"; exit 1; }

    # Create the sketch under the given name
    arduino-cli sketch new "$name" >/dev/null && \
    printf "\033[1;36mCreated new sketch: %s\033[0m\n" "$HOME/Documents/Arduino/Sketchbook/$name"
    ;;

  2|a|A|attach|ATTACH)
    # Prompt for sketch name
    printf "\033[1;36mSketch name ›\033[0m "
    read -r name
    [ -n "${name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No name given. Exiting."; exit 1; }
    SKETCH_PATH="$HOME/Documents/Arduino/Sketchbook/$name"
    # check if sketch folder exists 
    if [ ! -d "$SKETCH_PATH" ]; then
      printf "\033[1;31m%s\033[0m\n" "Sketch folder not found: $SKETCH_PATH"
      exit 1
    fi
    # check if sketch folder contains at least one .ino file
    if ! ls "$SKETCH_PATH"/*.ino >/dev/null 2>&1; then
      printf "\033[1;31m%s\033[0m\n" "No .ino found in: $SKETCH_PATH (not a valid Arduino sketch folder?)"
      exit 1
    fi

    # Prompt for entering fqbn
    printf "\033[1;36mFQBN ›\033[0m "
    read -r fqbn
    [ -n "${fqbn:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No fqbn given. Exiting."; exit 1; }

    # Prompt to capture the serial port device name
    printf "\033[1;36mSerial port device name ›\033[0m "
    read -r device
    [ -n "${device:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No device name given. Exiting."; exit 1; }

    # Register serial port's path
    PORT="/dev/$device"
    # Check if the device can be found and can be accessed
    [ -c "$PORT" ] || { printf "\033[1;31m%s\033[0m\n" "Device not found: $PORT, make sure that it is plugged in"; exit 1; }
    [ -r "$PORT" ] && [ -w "$PORT" ] || printf "\033[1;33m%s\033[0m\n" "Warning: may lack permission for $PORT (dialout/uucp group?)"

    # Assuming the programmer flag be default
    printf "\033[1;36mAssuming default programmer flag, if needed to be customized, go change the script\033[0m\n"

    # Attach sketch to the board
    arduino-cli board attach -p "$PORT" -b "$fqbn" "$SKETCH_PATH"
    ;;

  3|archive|Archive|zip)
    # Prompt for sketch name
    printf "\033[1;36mSketch name to archive ›\033[0m "
    read -r sketch_name
    [ -n "${sketch_name:-}" ] || { printf "\033[1;31m%s\033[0m\n" "No sketch name given. Exiting."; exit 1; }
    SKETCHPATH="$HOME/Documents/Arduino/Sketchbook/$sketch_name"

    # check if sketch folder exists 
    if [ ! -d "$SKETCHPATH" ]; then
      printf "\033[1;31m%s\033[0m\n" "Sketch folder not found: $SKETCHPATH"
      exit 1
    fi

    # Prompt for the destination archive path
    printf "\033[1;36mArchive file path (e.g. Documents/arduino/) › \033[0m"
    read -r archive_path
    [ -n "$archive_path" ] || { printf "\033[1;31m%s\033[0m\n" "No archive path given. Exiting."; exit 1; }
    ARCHIVEPATH="$HOME/$archive_path"

    # check if the archive path exists 
    if [ ! -d "$ARCHIVEPATH" ]; then
      printf "\033[1;31m%s\033[0m\n" "The destination path not found: $ARCHIVEPATH"
      exit 1
    fi

    # Archive
    arduino-cli archive "$SKETCHPATH" "$ARCHIVEPATH/$sketch_name.zip"
    ;;

  4|l|ls)
    ls "$HOME/Documents/Arduino/Sketchbook/"
    ;;

  5|b|B|back|BACK)
    clear
    arduino
    ;;

  *)
    printf "\033[1;31m%s\033[0m\n" "Invalid choice"
    exit 1
    ;;
esac
