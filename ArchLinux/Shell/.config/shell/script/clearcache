#!/bin/sh
set -eu

# Clear package manager caches
yay -Scc
printf "\033[1;36m%s\033[0m\n" "Package manager caches cleared"

# Clear language/tool caches
cargo cache -e
printf "\033[1;36m%s\033[0m\n" "Cargo caches cleared"
npm cache clean --force
printf "\033[1;36m%s\033[0m\n" "NPM caches cleared"
go clean -cache -modcache -testcache -fuzzcache
printf "\033[1;36m%s\033[0m\n" "Go caches cleared"

# Clear python package's cache
[ -d "$HOME/.cache/pip" ] && rm -rf -- "${HOME:?}/.cache/pip/"*
printf "\033[1;36m%s\033[0m\n" "Python package download cache cleared"

# Clear deno cache
deno clean
printf "\033[1;36m%s\033[0m\n" "Deno cache cleared"

# Clear Arduino CLI download staging cache
arduino-cli cache clean
printf "\033[1;36m%s\033[0m\n" "Arduino download staging cache cleared"

# Clear flatpak cache
flatpak uninstall --user --unused
rm -rf ~/.cache/flatpak/*
printf "\033[1;36m%s\033[0m\n" "Flatpak's cache and unused ressources cleared"

# Prompt to see if clear orcaslicer's cache
printf "\033[38;5;208mClear OrcaSlicer's cache ? It will be rebuild on startup.\033[0m\n"
size_1=$(du -sh /home/Zrabbit/.var/app/io.github.softfever.OrcaSlicer/cache | awk '{print $1}' )
size_2=$(du -sh /home/Zrabbit/.var/app/io.github.softfever.OrcaSlicer/config/OrcaSlicer/cache | awk '{print $1}' )
printf "\033[1;36m%s\033[0m\n" "Current cache size = $size_1, config cache size = $size_2."
printf "\033[1;36mYour choice (yes/no) â€º\033[0m "
read -r choice
case "${choice:-}" in
    1|y|Y|yes|YES|o|O|oui|OUI)
        find /home/Zrabbit/.var/app/io.github.softfever.OrcaSlicer/cache -mindepth 1 -delete
        find /home/Zrabbit/.var/app/io.github.softfever.OrcaSlicer/config/OrcaSlicer/cache -mindepth 1 -delete
        find /home/Zrabbit/.var/app/io.github.softfever.OrcaSlicer/config/OrcaSlicer/log -mindepth 1 -delete
        ;;
    2|n|N|no|NO|non|NON)
        ;;
esac


# Refresh shell command hash (harmless in non-interactive shells)
command -v hash >/dev/null 2>&1 && hash -r || true
printf "\033[1;36m%s\033[0m\n" "Shell command hash refreshed"

# Check if there is any orphan dependencies
nb_orphans="$(pacman -Qdtq 2>/dev/null || true)"
if [ -n "$nb_orphans" ]; then
  printf "\033[1;31m%s\033[0m\n%s\n" "Orphans found:" "$nb_orphans"
else
  printf "\033[1;36m%s\033[0m\n" "No orphans found"
fi
